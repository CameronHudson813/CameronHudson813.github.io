<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cameron Hudson">
<meta name="dcterms.date" content="2025-03-12">
<meta name="description" content="Using the PUMS dataset to predict employment and audit for racial bias.">

<title>Auditing Bias – My Awesome CSCI 0451 Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6de787833effe4777a6777a5e05fb578.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background-image: url(../../img/landscape.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">My Awesome CSCI 0451 Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Cameron Hudson’s Machine Learning Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Auditing Bias</h1>
                  <div>
        <div class="description">
          Using the PUMS dataset to predict employment and audit for racial bias.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Cameron Hudson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 12, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>Today, we will be using the PUMS dataset to predict employment of members in the state of Michigan that are within the dataset, as well as auditing for racial bias. The process we will be using is first implementing a SVC to predict employment status based on features excluding race and the target variable (employment status), then evaluating our findings based on statistical definitions of fairness, such as calibration, error rate balance, and statistical parity of each racial group (white, black, or other). Through this process, I evaluated my model as passing both approximate cabliration and error rate balance tests but failing the statistical parity test, with white people having a higher rate of being predicted to be employed than black people or other people of a self-identified racial identity. Overall, I note in the conclusion the predicted impact of implementing this predictor model at large and note potential issues/uncomforabilites.</p>
</section>
<section id="fetching-pums-dataset" class="level1">
<h1>Fetching PUMS Dataset</h1>
<p>First we will download the data that we are working with:</p>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folktables <span class="im">import</span> ACSDataSource, ACSEmployment, BasicProblem, adult_filter</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>STATE <span class="op">=</span> <span class="st">"MI"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>data_source <span class="op">=</span> ACSDataSource(survey_year<span class="op">=</span><span class="st">'2018'</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                            horizon<span class="op">=</span><span class="st">'1-Year'</span>, </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                            survey<span class="op">=</span><span class="st">'person'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>acs_data <span class="op">=</span> data_source.get_data(states<span class="op">=</span>[STATE], download<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>acs_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RT</th>
<th data-quarto-table-cell-role="th">SERIALNO</th>
<th data-quarto-table-cell-role="th">DIVISION</th>
<th data-quarto-table-cell-role="th">SPORDER</th>
<th data-quarto-table-cell-role="th">PUMA</th>
<th data-quarto-table-cell-role="th">REGION</th>
<th data-quarto-table-cell-role="th">ST</th>
<th data-quarto-table-cell-role="th">ADJINC</th>
<th data-quarto-table-cell-role="th">PWGTP</th>
<th data-quarto-table-cell-role="th">AGEP</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">PWGTP71</th>
<th data-quarto-table-cell-role="th">PWGTP72</th>
<th data-quarto-table-cell-role="th">PWGTP73</th>
<th data-quarto-table-cell-role="th">PWGTP74</th>
<th data-quarto-table-cell-role="th">PWGTP75</th>
<th data-quarto-table-cell-role="th">PWGTP76</th>
<th data-quarto-table-cell-role="th">PWGTP77</th>
<th data-quarto-table-cell-role="th">PWGTP78</th>
<th data-quarto-table-cell-role="th">PWGTP79</th>
<th data-quarto-table-cell-role="th">PWGTP80</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>P</td>
<td>2018GQ0000064</td>
<td>3</td>
<td>1</td>
<td>2907</td>
<td>2</td>
<td>26</td>
<td>1013097</td>
<td>8</td>
<td>60</td>
<td>...</td>
<td>9</td>
<td>0</td>
<td>12</td>
<td>9</td>
<td>11</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>10</td>
<td>12</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>P</td>
<td>2018GQ0000154</td>
<td>3</td>
<td>1</td>
<td>1200</td>
<td>2</td>
<td>26</td>
<td>1013097</td>
<td>92</td>
<td>20</td>
<td>...</td>
<td>92</td>
<td>91</td>
<td>93</td>
<td>95</td>
<td>93</td>
<td>173</td>
<td>91</td>
<td>15</td>
<td>172</td>
<td>172</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>P</td>
<td>2018GQ0000158</td>
<td>3</td>
<td>1</td>
<td>2903</td>
<td>2</td>
<td>26</td>
<td>1013097</td>
<td>26</td>
<td>54</td>
<td>...</td>
<td>26</td>
<td>52</td>
<td>3</td>
<td>25</td>
<td>25</td>
<td>28</td>
<td>28</td>
<td>50</td>
<td>51</td>
<td>25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P</td>
<td>2018GQ0000174</td>
<td>3</td>
<td>1</td>
<td>1801</td>
<td>2</td>
<td>26</td>
<td>1013097</td>
<td>86</td>
<td>20</td>
<td>...</td>
<td>85</td>
<td>12</td>
<td>87</td>
<td>12</td>
<td>87</td>
<td>85</td>
<td>157</td>
<td>86</td>
<td>86</td>
<td>86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>P</td>
<td>2018GQ0000212</td>
<td>3</td>
<td>1</td>
<td>2600</td>
<td>2</td>
<td>26</td>
<td>1013097</td>
<td>99</td>
<td>33</td>
<td>...</td>
<td>98</td>
<td>96</td>
<td>98</td>
<td>95</td>
<td>174</td>
<td>175</td>
<td>96</td>
<td>95</td>
<td>179</td>
<td>97</td>
</tr>
</tbody>
</table>

<p>5 rows × 286 columns</p>
</div>
</div>
</div>
</section>
<section id="feature-selection" class="level1">
<h1>Feature Selection</h1>
<p>For the purposes of our demonstration, we only need a small subset of the features offered.</p>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>possible_features<span class="op">=</span>[<span class="st">'AGEP'</span>, <span class="st">'SCHL'</span>, <span class="st">'MAR'</span>, <span class="st">'RELP'</span>, <span class="st">'DIS'</span>, <span class="st">'ESP'</span>, <span class="st">'CIT'</span>, <span class="st">'MIG'</span>, <span class="st">'MIL'</span>, <span class="st">'ANC'</span>, <span class="st">'NATIVITY'</span>, <span class="st">'DEAR'</span>, <span class="st">'DEYE'</span>, <span class="st">'DREM'</span>, <span class="st">'SEX'</span>, <span class="st">'RAC1P'</span>, <span class="st">'ESR'</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>acs_data[possible_features].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">AGEP</th>
<th data-quarto-table-cell-role="th">SCHL</th>
<th data-quarto-table-cell-role="th">MAR</th>
<th data-quarto-table-cell-role="th">RELP</th>
<th data-quarto-table-cell-role="th">DIS</th>
<th data-quarto-table-cell-role="th">ESP</th>
<th data-quarto-table-cell-role="th">CIT</th>
<th data-quarto-table-cell-role="th">MIG</th>
<th data-quarto-table-cell-role="th">MIL</th>
<th data-quarto-table-cell-role="th">ANC</th>
<th data-quarto-table-cell-role="th">NATIVITY</th>
<th data-quarto-table-cell-role="th">DEAR</th>
<th data-quarto-table-cell-role="th">DEYE</th>
<th data-quarto-table-cell-role="th">DREM</th>
<th data-quarto-table-cell-role="th">SEX</th>
<th data-quarto-table-cell-role="th">RAC1P</th>
<th data-quarto-table-cell-role="th">ESR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>60</td>
<td>15.0</td>
<td>5</td>
<td>17</td>
<td>1</td>
<td>NaN</td>
<td>1</td>
<td>1.0</td>
<td>4.0</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>1.0</td>
<td>1</td>
<td>2</td>
<td>6.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>20</td>
<td>19.0</td>
<td>5</td>
<td>17</td>
<td>2</td>
<td>NaN</td>
<td>1</td>
<td>1.0</td>
<td>4.0</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>2.0</td>
<td>2</td>
<td>1</td>
<td>6.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>54</td>
<td>18.0</td>
<td>3</td>
<td>16</td>
<td>1</td>
<td>NaN</td>
<td>1</td>
<td>1.0</td>
<td>4.0</td>
<td>4</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>1.0</td>
<td>1</td>
<td>1</td>
<td>6.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>20</td>
<td>18.0</td>
<td>5</td>
<td>17</td>
<td>2</td>
<td>NaN</td>
<td>1</td>
<td>1.0</td>
<td>4.0</td>
<td>4</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>2.0</td>
<td>1</td>
<td>1</td>
<td>6.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>33</td>
<td>18.0</td>
<td>5</td>
<td>16</td>
<td>2</td>
<td>NaN</td>
<td>1</td>
<td>3.0</td>
<td>4.0</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>2.0</td>
<td>1</td>
<td>1</td>
<td>6.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For the purposes of predicting employment status and auditing for racial bias we are going to exclude the features <code>ESR</code> (employment status) and <code>RAC1P</code> (race) from the set that we are going to train a machine learning model on.</p>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>features_to_use <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> possible_features <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"ESR"</span>, <span class="st">"RAC1P"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="constructing-the-basic-problem" class="level1">
<h1>Constructing the “Basic Problem”</h1>
<div id="cell-12" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>EmploymentProblem <span class="op">=</span> BasicProblem(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    features<span class="op">=</span>features_to_use,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    target<span class="op">=</span><span class="st">'ESR'</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    target_transform<span class="op">=</span><span class="kw">lambda</span> x: x <span class="op">==</span> <span class="dv">1</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    group<span class="op">=</span><span class="st">'RAC1P'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    preprocess<span class="op">=</span><span class="kw">lambda</span> x: x,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    postprocess<span class="op">=</span><span class="kw">lambda</span> x: np.nan_to_num(x, <span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>features, label, group <span class="op">=</span> EmploymentProblem.df_to_numpy(acs_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-test-split" class="level1">
<h1>Train Test Split</h1>
<p>In order to accurately evaluate the accuracy of machine learning models, we are going to train the model using the data from X_train, and test the model using the data from X_test. Note we are seperating the sensitive feature <code>RAC1P</code> into the <code>group</code> array which we will use later on when we audit the model for racial bias.</p>
<div id="cell-14" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test, group_train, group_test <span class="op">=</span> train_test_split(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    features, label, group, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-analysis-questions" class="level1">
<h1>Data Analysis Questions</h1>
<p>In order to properly analyze our data, we are first going to answer a few questions regarding the types of people in our dataset that will gives us more insight we when attempt to audit for racial bias.</p>
<div id="cell-16" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(X_train, columns <span class="op">=</span> features_to_use)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"group"</span>] <span class="op">=</span> group_train</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"label"</span>] <span class="op">=</span> y_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, before we attempt to answer the questions, turn our X_train array back into a pandas DataFrame to make the analysis of the dataset easier.</p>
<ol type="1">
<li>How many people are in the dataset?</li>
</ol>
<div id="cell-19" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>individuals <span class="op">=</span> df.shape[<span class="dv">0</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>individuals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>79535</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>What proportion of these people have a target label == <code>1</code>? Where <code>1</code> whould correspond with the person being employed and <code>0</code> would correspond with the person being unemployed.</li>
</ol>
<div id="cell-21" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>employed <span class="op">=</span> df[df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">True</span>].shape[<span class="dv">0</span>] <span class="op">/</span> individuals</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>employed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>0.44297479097252784</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Of these individuals, how many are in each group?</li>
</ol>
<div id="cell-23" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>group1_proportion <span class="op">=</span> df[df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">1</span>].shape[<span class="dv">0</span>] <span class="op">/</span> individuals</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>group2_proportion <span class="op">=</span> df[df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">2</span>].shape[<span class="dv">0</span>] <span class="op">/</span> individuals</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>group3_proportion <span class="op">=</span> df[df[<span class="st">"group"</span>] <span class="op">&gt;=</span> <span class="dv">3</span>].shape[<span class="dv">0</span>] <span class="op">/</span> individuals</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>groups_series <span class="op">=</span> pd.Series({<span class="st">'white'</span>: group1_proportion, <span class="st">'black'</span> : group2_proportion, <span class="st">'other'</span> : group3_proportion})</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>groups_dataframe <span class="op">=</span> pd.DataFrame(groups_series, columns<span class="op">=</span>[<span class="st">'groups_series'</span>])</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>groups_dataframe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">groups_series</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">white</td>
<td>0.847614</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">black</td>
<td>0.086515</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>0.065870</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<ol start="4" type="1">
<li>In each group, what proportion of indiviuals have a target label == 1? (Meaning they are employed)</li>
</ol>
<div id="cell-25" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>group1_employed, group1_unemployed <span class="op">=</span> df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">True</span>)].shape[<span class="dv">0</span>], df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">False</span>)].shape[<span class="dv">0</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>group2_employed, group2_unemployed <span class="op">=</span> df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">2</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">True</span>)].shape[<span class="dv">0</span>], df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">2</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">False</span>)].shape[<span class="dv">0</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>group3_employed, group3_unemployed <span class="op">=</span> df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">3</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">True</span>)].shape[<span class="dv">0</span>], df[(df[<span class="st">"group"</span>] <span class="op">==</span> <span class="dv">3</span>) <span class="op">&amp;</span> (df[<span class="st">"label"</span>] <span class="op">==</span> <span class="va">False</span>)].shape[<span class="dv">0</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>group1_employ_proportion <span class="op">=</span> pd.Series({<span class="st">'employed'</span> : group1_employed <span class="op">/</span> individuals, <span class="st">'unemployed'</span> : group1_unemployed <span class="op">/</span> individuals})</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>group2_employ_proportion <span class="op">=</span> pd.Series({<span class="st">'employed'</span> : group2_employed <span class="op">/</span> individuals, <span class="st">'unemployed'</span> : group2_unemployed <span class="op">/</span> individuals})</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>group3_employ_proportion <span class="op">=</span> pd.Series({<span class="st">'employed'</span> : group2_employed <span class="op">/</span> individuals, <span class="st">'unemployed'</span> : group3_unemployed <span class="op">/</span> individuals})</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>group_employ_dataframe <span class="op">=</span> pd.DataFrame({<span class="st">'white'</span>: group1_employ_proportion, <span class="st">'black'</span>: group2_employ_proportion, <span class="st">'other'</span>: group3_employ_proportion})</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>group_employ_dataframe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">white</th>
<th data-quarto-table-cell-role="th">black</th>
<th data-quarto-table-cell-role="th">other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">employed</td>
<td>0.385516</td>
<td>0.029924</td>
<td>0.029924</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unemployed</td>
<td>0.462098</td>
<td>0.056591</td>
<td>0.003407</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<ol start="5" type="1">
<li>What are the intersectional trends of people in the dataset that are employed? For example, race (<code>RAC1P</code>) and sex (<code>SEX</code>)?</li>
</ol>
<div id="cell-27" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>df_barplot <span class="op">=</span> df.copy()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>df_barplot[<span class="st">'RACE_CAT'</span>] <span class="op">=</span> df_barplot[<span class="st">'group'</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="st">'White'</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> (<span class="st">'Black'</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'Other'</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>employment_rates <span class="op">=</span> df_barplot.groupby([<span class="st">'RACE_CAT'</span>, <span class="st">'SEX'</span>])[<span class="st">'label'</span>].mean().reset_index()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>employment_rates[<span class="st">'SEX'</span>] <span class="op">=</span> employment_rates[<span class="st">'SEX'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'Male'</span>, <span class="dv">2</span>: <span class="st">'Female'</span>})</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>sns.barplot(employment_rates, x<span class="op">=</span><span class="st">"RACE_CAT"</span>, y<span class="op">=</span><span class="st">'label'</span>, hue<span class="op">=</span><span class="st">"SEX"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Race"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Proportion Employed"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Proportion of Employed People by Race and Gender"</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)  </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">"Sex"</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-analysis-conclusion" class="level1">
<h1>Data Analysis Conclusion</h1>
<p>With these findings, we gather some important information that can help inform our racial bias audit. We see that the dataset is heavily dominated with white people which may skew our predictor model from being able to accurately predict the employment status of other racial groups. We also see that white people within the dataset have a higher proportion of employed group members than other racial groups, so our predictor model should likely mirror that disparity.</p>
</section>
<section id="training-svc-model" class="level1">
<h1>Training SVC Model</h1>
<p>Now that we have gathered information, it is time to train predictor model using the training dataset. We will be using a Support Vector Classifier (SVC) to predict employment status of the members of our dataset.</p>
<p>Above we have created the dataframes X_train, X_test, y_train, y_test, so now we must plug them into the sklearn SVC function. We use sklearn <code>make_pipeline</code> function to first run the dataset through the <code>StandardScaler</code> function before moving to our SVC (support vector classifier) machine learning model.</p>
<div id="cell-31" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> make_pipeline(StandardScaler(), SVC(C<span class="op">=</span><span class="dv">10</span>, probability<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> model.predict(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we use the <code>model.predict()</code> function on X_test and store the result in <code>y_hat</code>. Now, <code>y_hat</code> is a boolean array which contains all the predictions (employed == True, unemployed == False) for each row of the X_test dataset.</p>
<div id="cell-33" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>y_hat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([ True,  True,  True, ...,  True,  True, False], shape=(19884,))</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>group_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>array([1, 1, 1, ..., 1, 8, 9], shape=(19884,))</code></pre>
</div>
</div>
</section>
<section id="model-auditing" class="level1">
<h1>Model Auditing</h1>
<p>Now that we have created the predictor model, we can now audit the model, first concerning ourself on its overall accurracy. Below, we ask a few questions that will give us an idea of the accuracy of the model.</p>
<section id="overall-measures" class="level2">
<h2 class="anchored" data-anchor-id="overall-measures">Overall Measures</h2>
<ol type="1">
<li>What is the overall accuracy of the model?</li>
<li>What is the positive predictive value (PPV) of the model?</li>
<li>What are the overall false negative and flase positive rates (FNP and FPR) for the model?</li>
</ol>
<section id="overall-acurracy-of-model" class="level3">
<h3 class="anchored" data-anchor-id="overall-acurracy-of-model">Overall Acurracy of Model</h3>
<p>To get the overall accuracy of the model, get a boolean vector through <code>(y_hat == y_test)</code> which will give an array of truth or false values corresponding to the equality of the prediction and the actual value. To get the percentage of the correct predictions in the boolean vector, we take the mean with the <code>mean()</code> function.</p>
<div id="cell-40" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_accuracy <span class="op">=</span> (y_hat <span class="op">==</span> y_test).mean()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model_accuracy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>np.float64(0.825940454636894)</code></pre>
</div>
</div>
<p>The overall accuracy of the model is approximately 82.5%</p>
</section>
<section id="ppv-of-the-model" class="level3">
<h3 class="anchored" data-anchor-id="ppv-of-the-model">PPV of the Model</h3>
<p>To get the positive predictive value of the model, we divide the number of true positives (TP) by the total number of positive predictions (TP + FP)</p>
<div id="cell-44" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>confusion_array <span class="op">=</span> confusion_matrix(y_test, y_hat)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>confusion_array</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([[8744, 2269],
       [1192, 7679]])</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>TP <span class="op">=</span> confusion_array[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> confusion_array[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>FP <span class="op">=</span> confusion_array[<span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> confusion_array[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>PPV <span class="op">=</span> TP <span class="op">/</span> (TP<span class="op">+</span>FP)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>PPV</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>np.float64(0.8800322061191627)</code></pre>
</div>
</div>
</section>
<section id="fpr-and-fnr-of-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fpr-and-fnr-of-the-model">FPR and FNR of the Model</h3>
<p>Similarly, we can use the confusion matrix to get the FPR and FNR of the model</p>
<div id="cell-47" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># False positive rate calculation</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>FPR <span class="op">=</span> FP <span class="op">/</span> (FP <span class="op">+</span> TN)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>FPR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>np.float64(0.1343704204711983)</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># False negative rate calculation</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>FNR <span class="op">=</span> FN <span class="op">/</span> (FN <span class="op">+</span> TP)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>FNR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>np.float64(0.2060292381730682)</code></pre>
</div>
</div>
</section>
</section>
<section id="by-group-measures" class="level2">
<h2 class="anchored" data-anchor-id="by-group-measures">By-Group Measures</h2>
<p>Now that we have observed the overall accuracy of the model, we now concern ourselves with the accuracy of the model as it pertains to the racial groups (white, black, other) that exist within the dataset. Below we ask a few questions:</p>
<ol type="1">
<li>What is the accuracy of your model on each subgroup</li>
<li>What is the PPV of your model on each subgroup?</li>
<li>What are the FNR and FPR on each subgroup?</li>
</ol>
<p>To answer question 1, we can make a summary table displaying the accuracy of the model on each subgroup</p>
<div id="cell-51" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>accuracy_group_1 <span class="op">=</span> (y_hat[group_test <span class="op">==</span> <span class="dv">1</span>] <span class="op">==</span> y_test[group_test <span class="op">==</span> <span class="dv">1</span>]).mean()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>accuracy_group_2 <span class="op">=</span> (y_hat[group_test <span class="op">==</span> <span class="dv">2</span>] <span class="op">==</span> y_test[group_test <span class="op">==</span> <span class="dv">2</span>]).mean()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>accuracy_group_3 <span class="op">=</span> (y_hat[group_test <span class="op">==</span> <span class="dv">3</span>] <span class="op">==</span> y_test[group_test <span class="op">==</span> <span class="dv">3</span>]).mean()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>subgroup_accuracy <span class="op">=</span> pd.Series({<span class="st">"White"</span>: accuracy_group_1,<span class="st">"Black"</span>: accuracy_group_2, <span class="st">"Other"</span>: accuracy_group_3})</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>sub_acc_df <span class="op">=</span> pd.DataFrame(subgroup_accuracy, columns<span class="op">=</span>[<span class="st">"Accuracy"</span>])</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>sub_acc_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">White</td>
<td>0.827000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Black</td>
<td>0.816878</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>0.793651</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>To answer question 2, we can return to the idea of confusion matrices, making one for each subgroup and calculating the PPV as TP (True Positive Predictions) / TP + FP (False Positive Predictions).</p>
<div id="cell-53" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>white_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">1</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">1</span>])  </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>black_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">2</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">2</span>])</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>other_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">3</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">3</span>])</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>white_PPV <span class="op">=</span> white_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (white_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> white_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>black_PPV <span class="op">=</span> black_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (black_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> black_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>])</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>other_PPV <span class="op">=</span> other_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (other_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> other_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>])</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>group_PPV <span class="op">=</span> pd.Series({<span class="st">"white"</span>: white_PPV,<span class="st">"black"</span>: black_PPV, <span class="st">"other"</span>: other_PPV})</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>group_PPV_df <span class="op">=</span> pd.DataFrame(group_PPV, columns<span class="op">=</span>[<span class="st">"PPV"</span>])</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>group_PPV_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PPV</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">white</td>
<td>0.791346</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">black</td>
<td>0.801043</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>0.743590</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>To answer question 3, we can take a simiar approach as shown above, only switching the values that we are taking from the confusion matrix</p>
<div id="cell-55" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>white_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">1</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">1</span>])  </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>black_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">2</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">2</span>])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>other_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">3</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">3</span>])</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>white_FNR <span class="op">=</span> white_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">/</span> (white_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> white_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>white_FPR <span class="op">=</span> white_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">/</span> (white_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> white_confusion_array[<span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>black_FNR <span class="op">=</span> black_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">/</span> (black_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> black_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>black_FPR <span class="op">=</span> black_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">/</span> (black_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> black_confusion_array[<span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>other_FNR <span class="op">=</span> other_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">/</span> (other_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> other_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>other_FPR <span class="op">=</span> other_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">/</span> (other_confusion_array[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> other_confusion_array[<span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>group_FNR <span class="op">=</span> pd.Series({<span class="st">"white"</span>: white_FNR,<span class="st">"black"</span>: black_FNR, <span class="st">"other"</span>: other_FNR})</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>group_FPR <span class="op">=</span> pd.Series({<span class="st">"white"</span>: white_FPR,<span class="st">"black"</span>: black_FPR, <span class="st">"other"</span>: other_FPR})</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>group_FPR_FNR_df <span class="op">=</span> pd.DataFrame({<span class="st">"FNR"</span>: group_FNR, <span class="st">"FPR"</span>: group_FPR})</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>group_FPR_FNR_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">FNR</th>
<th data-quarto-table-cell-role="th">FPR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">white</td>
<td>0.122824</td>
<td>0.220930</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">black</td>
<td>0.100488</td>
<td>0.290609</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>0.093750</td>
<td>0.322581</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="bias-measures" class="level2">
<h2 class="anchored" data-anchor-id="bias-measures">Bias Measures</h2>
<p>Now that we have evaluted the overall accuracy and the accuracy within groups of the model, we now use statistical definitions of fairness to ascertain a sense of the models “fairness”. Below, we ask a few questions:</p>
<ol type="1">
<li>Is the model approximately calibrated?</li>
<li>Does the model satisfy approximate error rate balance?</li>
<li>Does the model satisfy statistical parity?</li>
</ol>
</section>
</section>
<section id="calibration" class="level1">
<h1>Calibration</h1>
<p>In order to show the calibration of the model, we can define a line for each group using sklearn’s <code>calibration_curve()</code> function that shows the relationship between the model’s confidence in an instance x being unemployed and the actual probability of a member of group x being unemployed in the data. The dashed line depicts the result of a perfectly calibrated model.</p>
<div id="cell-59" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> calibration_curve</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>prob_true, prob_pred <span class="op">=</span> calibration_curve(y_test[group_test <span class="op">==</span> <span class="dv">1</span>], y_hat[group_test <span class="op">==</span> <span class="dv">1</span>], n_bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.plot(prob_pred, prob_true)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Predicted Probability'</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'True Probability'</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calibration Plot'</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>prob_true, prob_pred <span class="op">=</span> calibration_curve(y_test[group_test <span class="op">==</span> <span class="dv">2</span>], y_hat[group_test <span class="op">==</span> <span class="dv">2</span>], n_bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>plt.plot(prob_pred, prob_true)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>prob_true, prob_pred <span class="op">=</span> calibration_curve(y_test[group_test <span class="op">&gt;=</span> <span class="dv">3</span>], y_hat[group_test <span class="op">&gt;=</span> <span class="dv">3</span>], n_bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>plt.plot(prob_pred, prob_true)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>We can see that for each group, the calibration curve is roughly the same. While the model generally over estimates between scores 0 and 0.4 and underestimates between 0.4 and 1.0, the calibration error is approximately the same between all three groups, making this model approximately well-calibrated.</p>
</section>
<section id="error-rate-balance" class="level1">
<h1>Error Rate Balance</h1>
<p>To answer question 2, we must see if the true positive and false positive rates between the three groups are roughly equal. As we have done before, we display a dataframe that will allow us to analyze the relationship of the true postive and false positive rates between groups. Because we have already computed the false positive rate for each group, we only need to compute the true positive rate.</p>
<div id="cell-63" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>white_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">1</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">1</span>])  </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>black_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">2</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">2</span>])</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>other_confusion_array <span class="op">=</span> confusion_matrix((y_test[group_test <span class="op">==</span> <span class="dv">3</span>]), y_hat[group_test <span class="op">==</span> <span class="dv">3</span>])</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>white_TPR <span class="op">=</span> white_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (white_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> white_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>black_TPR <span class="op">=</span> black_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (black_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> black_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>other_TPR <span class="op">=</span> other_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">/</span> (other_confusion_array[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> other_confusion_array[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>group_TPR <span class="op">=</span> pd.Series({<span class="st">"white"</span>: white_TPR,<span class="st">"black"</span>: black_TPR, <span class="st">"other"</span>: other_TPR})</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>group_TPR_FPR_df <span class="op">=</span> pd.DataFrame({<span class="st">"TPR"</span>: group_TPR, <span class="st">"FPR"</span>: group_FPR})</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>group_TPR_FPR_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">TPR</th>
<th data-quarto-table-cell-role="th">FPR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">white</td>
<td>0.877176</td>
<td>0.220930</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">black</td>
<td>0.899512</td>
<td>0.290609</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>0.906250</td>
<td>0.322581</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see that between the 3 groups, the TPR and FPR are roughly the same, with the TPR for each group around 90% and the FPR around 30%.</p>
</section>
<section id="statistical-parity" class="level1">
<h1>Statistical Parity</h1>
<p>To answer question 3 and evaluate the model for statistical parity, we must evaluate if the probability of positive prediction (this person is predicted to be employed) is the same across the different groups (black, white, other).</p>
<div id="cell-67" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>prob_white <span class="op">=</span> X_test[(group_test <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (y_hat <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">==</span> <span class="dv">1</span>].shape[<span class="dv">0</span>] </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>prob_black <span class="op">=</span> X_test[(group_test <span class="op">==</span> <span class="dv">2</span>) <span class="op">&amp;</span> (y_hat <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">==</span> <span class="dv">2</span>].shape[<span class="dv">0</span>] </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>prob_other <span class="op">=</span> X_test[(group_test <span class="op">&gt;=</span> <span class="dv">3</span>) <span class="op">&amp;</span> (y_hat <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">&gt;=</span> <span class="dv">3</span>].shape[<span class="dv">0</span>] </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>prob_series <span class="op">=</span> pd.Series({<span class="st">"white"</span>: prob_white, <span class="st">"black"</span>: prob_black, <span class="st">"other"</span>: prob_other})</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>prob_df <span class="op">=</span> pd.DataFrame(prob_series, columns<span class="op">=</span>[<span class="st">"Probability of Employed Prediction"</span>])</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>prob_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Probability of Employed Prediction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">white</td>
<td>0.511448</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">black</td>
<td>0.434639</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>0.445860</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see here that model does not pass the test of statistical parity, as the <code>black</code> and <code>other</code> groups have roughly the same percentage, however the <code>white</code> group is ahead of both by roughly 7 percent.</p>
<p>We will conclude our visual demonstration of the fairness of this model by showing the relationship between the FPR and FNR of each group as well as the possible FNR and FPR values, depicted by lines showing the relationship between the FPR and FNR.</p>
<div id="cell-70" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#FPR and FNR for each group</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>FPR_groups <span class="op">=</span> [white_FPR, black_FPR, other_FPR]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>FNR_groups <span class="op">=</span> [white_FNR, black_FNR, other_FNR]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">#prevalance percentage for each group</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>white_p <span class="op">=</span> X_test[(group_test <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">==</span> <span class="dv">1</span>].shape[<span class="dv">0</span>]</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>black_p <span class="op">=</span> X_test[(group_test <span class="op">==</span> <span class="dv">2</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">==</span> <span class="dv">2</span>].shape[<span class="dv">0</span>]</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>other_p <span class="op">=</span> X_test[(group_test <span class="op">&gt;=</span> <span class="dv">3</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>)].shape[<span class="dv">0</span>] <span class="op">/</span> X_test[group_test <span class="op">&gt;=</span> <span class="dv">3</span>].shape[<span class="dv">0</span>]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Calibrating model </span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>group_PPV <span class="op">=</span> <span class="bu">min</span>(white_PPV, black_PPV, other_PPV)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co">#line of feasible FPR and FNR values for each group</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>fnr_values <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">100</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>white_fpr_values <span class="op">=</span> (white_p <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> white_p)) <span class="op">*</span> ((<span class="dv">1</span> <span class="op">-</span> group_PPV) <span class="op">/</span> group_PPV) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> fnr_values)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>black_fpr_values <span class="op">=</span> (black_p <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> black_p)) <span class="op">*</span> ((<span class="dv">1</span> <span class="op">-</span> group_PPV) <span class="op">/</span> group_PPV) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> fnr_values)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>other_fpr_values <span class="op">=</span> (other_p <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> other_p)) <span class="op">*</span> ((<span class="dv">1</span> <span class="op">-</span> group_PPV) <span class="op">/</span> group_PPV) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> fnr_values)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>pyplot.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">5</span>))</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>pyplot.title(<span class="st">"Feasible (FNR, FPR) combinations"</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>pyplot.xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>pyplot.xlabel(<span class="st">"False Negative Rate"</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>pyplot.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>pyplot.ylabel(<span class="st">"False Positive Rate"</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>group_labels <span class="op">=</span> [<span class="st">"White"</span>, <span class="st">"Black"</span>, <span class="st">"Other"</span>]</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> {<span class="st">"White"</span>: <span class="st">"yellow"</span>, <span class="st">"Black"</span>: <span class="st">"black"</span>, <span class="st">"Other"</span>: <span class="st">"red"</span>}</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>FNR_groups, y<span class="op">=</span>FPR_groups, hue <span class="op">=</span> group_labels, palette<span class="op">=</span>palette)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>fnr_values, y <span class="op">=</span> white_fpr_values, color<span class="op">=</span><span class="st">"yellow"</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>fnr_values, y <span class="op">=</span> black_fpr_values, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>fnr_values, y <span class="op">=</span> other_fpr_values, color<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>pyplot.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="balancing-the-fpr" class="level1">
<h1>Balancing the FPR</h1>
<p>This plot could also assist in answering the following question: If the classifier threshold is tuned so that FPR is equal between groups, how much would be need to change the FNR?</p>
<p>As shown by the graph, the converging of the line shows when FPR’s for each group become equal. In order to make the FPR equal between each group, the FNR would have to be approximately 0.8.</p>
</section>
<section id="concluding-discussion" class="level1">
<h1>Concluding Discussion</h1>
<p>To conclude our discussion auditing the fairness of this model that predicts employment status, I will answer a few questions regarding the overall fairness concerns and impact of this particular predictor model.</p>
<ol type="1">
<li>What groups of people stand to benefit from a system that is able to predict a person’s employment status?</li>
</ol>
<p>I believe that a predictor of employment status could be used for good by the government and companies aimed at getting the unemployed employed or simply want to find potential workers by using the model to find areas where unemployment is likely prevalent and develop resources to get more people employed.</p>
<ol start="2" type="1">
<li>Based on the bias audit, what could be the impact of deploying the model for large-scale prediction in commmerical or governmental settings?</li>
</ol>
<p>I feel that based on the bias audit conducted, the model is mostly accurate in its predictions, is approximately calibrated and has an approximate error rate balance, so use for large-scale prediction should have a positive impact, if the goal of the predictions is to find areas where people do not have jobs and work to give them jobs. This could also, however, negatively impact certain neighborhoods / demographics that have a large population of predicted unemployment, whereby stores may not want to open in those areas, or goverment/commerical forces make delibrate moves that make the lives of those people more difficult.</p>
<ol start="3" type="1">
<li>Based on the bias audit, do you feel that the model displays problematic bias?</li>
</ol>
<p>Because the model did not pass the statistical parity auditing test, with the rate of positive predictions (predicting said person is employed) for white people because statistically higher that black or racially self-identified people, the model could reinforce existing racial disparities in employment and therefore displays possible problematic bias.</p>
<ol start="4" type="1">
<li>Beyond bias, are there other potential problems associated with deployment of the model that feel uncomfortable? How could those problems be addressed?</li>
</ol>
<p>Beyond bias, I feel that because this predictor model is a black box, justification is not provided to those predicted to be employed or unemployed and that to me is uncomfortable. Because the prediction the model makes could have an impact on individual lives if this were implemented at a wide-scale on a goverment level, I would hope an implmentation to appeal or justify the predictions made by the model would be in place, and non-computer generated tasks could also aid in producing accurate predictions.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>